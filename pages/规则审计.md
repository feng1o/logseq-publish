- #### 需求分析：
  background-color:: #264c9b
  id:: 634f9af1-3768-4a20-8706-f27d78ebb800
  collapsed:: true
	- ##### 创建新规则
		- 支持的规则包括：SQL类型、数据库名、客户端IP、用户名、SQL命令详情（待确认）
			- sql类型
				- 支持条件:: 包含、包含
				  可选类型:: Alter、Changeuser、Create、delete、drop、execute、insert、login、logout、other、replace、select、set、update
				- 转换sql
				- ```
				  包含: alter Create  
				  	select * from TABLE where instance_id = "inst" and SqlType IN ("alter", "create")
				  不包含：alter create
				  	select * from TABLE where instance_id = "inst" and SqlType NOT IN ("alter", "create")
				  ```
			- dbName
				- 支持条件:: 包含、不包含、正则 （inc、exc、=、<>、reg）
				  限制:: 最多多少个db名
				  分隔符:: ,
			- client IP  / user  / SQL命令     --》==同上==
			- DONE 需确定是否支持动态加sql、过滤规则变了更新、太多对性能影响
			-
		- 单个规则 支持 包含、不包含、正则，还是一期仅支持包含（待确认）
			- > <span class=red>建议暂时不支持复杂正则，暂时支持sub_string里的包含： 比如： root001  --- 包含root，不要使用root[0-9]?</span>
		- 一个规则模板 中 可以支持多个规则
			- 简单理解为::  多个SQL类型、数据库名、客户端IP、用户名、SQL命令 ?
		- 不同规则之间 是 “&&”的关系
		  background-color:: #49767b
			- DONE 可改进 -- 规则之间关系应该由用户定义，否则需要多个
				- 如果是&&关系，无法满足部分场景，比如想要SqlType = delete 或 user = root的任何sql如何设置？
				- 规则表现形式:: 只有一个规则，类似一个sql，包含可过滤key：SQL类型、数据库名、客户端IP、用户名、SQL命令
				  比如：`sqlType = create  AND dbName = "test" OR clientIp = "127.0.0.1"`
				- |sqlType| ==关系==| dbName | ==关系==| clientIp | ==关系== | user|
				  |--|--|--|---|
				  |IN/NIN [CREATE, ALTER]| ==AND/OR==| test |  ==AND/OR== | 127.0.0.1 | ==AND/OR== | root |
				- sqlType: `IN ("CREATE", "ALTER", "DELETE"), NOT IN ("CREATE")`
		- 一个规则模板 中 同一个规则 只可加一条，比如同是 数据库名，在一个模板中要么仅支持包含，要么仅支持不包含
		  background-color:: #49767b
		- 一个规则内的不同条件间 是“||”的关系 -- 即: dbName -- IN / NOT IN
		  background-color:: #49767b
			- ![image.png](../assets/image_1666244706678_0.png)
		- 一个规则内的条件数量 限制，比如同是数据库名，可填写几个库名，需要内核研发根据性能损耗评估下（待确认）
			- DONE 待定
			- ```
			  规则设计： 开发功能上全覆盖，对外开发酌情考虑，适当保守。
			           功能(包含、不包含、等于、不等于、正则)均支持，正则是否放开待开发后压测待定，先支持存量规则正则审计。 
			           实例支持规则上限条数（可配置，暂定3条）；
			           条件内数量：不易过多，可配(sqlType:均支持； dbName，clientIp，userName等暂定上限5条）
			  ```
		- 每一条规则下面需要给出填写格式及限定条件提示文案（以上确认后再确认）
		- 规则内容展示样式，需要交互设计出图
		- 规则内容为选填项，但至少需要填写一个（需要交互设计出图 如何呈现）（待确认）
		- 备注：比如同是 数据库名，在一个规则模板中 要么仅支持包含，要么仅支持不包含，若用户设置的是：数据库名 包含 a、b、c，客户端IP 包含IP1、IP2、IP3，则该规则模板过滤出的审计日志为：数据库名 包含 a或b或c 且客户端IP 包含IP1或IP2或IP3的审计日志
	- ##### API
	  background-color:: #978626
		- ```bash
		  {"rule" : [ // 内部是||关系
		  		{ // 内部是 && 关系
		  			"sqlType" : {
		  				"op" : "inc/exc/eq/neq/reg"，
		  				"value" : ["CREATE", "ALTER", "DELETE"...]
		  			},
		  			"dbName" : {
		  				"op" : "inc/exc/eq/neq/reg",
		  				"value" : ["test", "db"...]
		  			},
		  			"clientIp" : {
		  				"op" : "inc/exc/eq/neq/reg",
		  				"value" : ["127.1", "test.xx.com"...]
		  			},
		  			"user" : {
		  				"op" : "inc/exc/eq/neq/reg",
		  				"value" : ["test", "root"...]
		  			},
		  			"sql" : {
		  				"op" : "inc/exc/eq/neq/reg",
		  				"value" : ["select * from tb1", "count"...]
		  			}
		  		},
		  		{
		  			"sqlType" : {
		  				"op" : "inc/exc/eq/neq/reg"，
		  				"value" : ["CREATE", "ALTER", "DELETE"...]
		  			}....
		  		},
		  	]
		  }
		  ```
-
	- 1.多个条件之间优先级，() 语义接卸
	- 2.多个rule优先级，命中一个后面忽略？命中一个就审计
	- 3.存量兼容，cdb这边开发阶段并存，后期迁移； 云平用户，如果开启新的，需考虑老的规则如何处理？删除，还是并行？
	- [[draws/2022-10-24-16-03-33.excalidraw]]
-
- ### CDB规则
  background-color:: #978626
	- 1.存量
		- 旧的rule policy的增删改查不变；  注册(改了需验证云平), --- publish流程会变，加一个自动生成全审计的conf
			- rule 增加    create_audit_rule
			- rule 修改    modify_audit_rule_cgi
			- rule 查询    query_audit_rule_cgi    --- [[$red]]==新的是::==  query_audit_rule_new_cgi
			- policy的创建  create_audit_policy_cgi    delete_audit_policy_cgi  modify_audit_policy_cgi     dao的重新生成影响吗？ 待验证
			-
			-
	- regist_audit_new
		- 怎么兼容？
			- ---   注册直接到 server里操作， 新的
			- ---  老的走topic_mgr，那保留      ------  发布到对应集群，需要同步status信息
			- 策略::  使用老的接口，注册一旦发布对应集群，就应该走新的
			  其他创建rule老的保留，create_audit_rule，云平可能没发。
			- 一旦发布，create_audit_poliyc就自动走新的，通过自动生成全审计搞定
			-
		- start_audit
		- shutdow_audit
		- recycle_audit
		- op_audit_rule
		-
		- csig (old)   ---  cdb(old集群) ----保留老的
		- csig(old) ---  cdb(new集群)    只支持全审计
			- create_audit_rule的各种操作保留---
			- create_audit_policy ---- >   不在创建policy，自动生成一个全审计； 直接走start_audit
			- clear_inst_audit_data_cgi    update_inst_audit_log_save_days_cgi: 这个需要保留其能力
		- 必须保留老的规则生成能力，能自动生成全审计即可，因为存量的迁移必须考虑到！！！！只有都去掉了才能去除这个能力。
			- 如果没有就默认生成一个全审计： 只需要适配status表的变更，tb_es，tb_kafka，按集群发布灰度适配
			- 开启、关闭审计直接走新的
	- 2.新的
		- 注册
		- 开
		- 关
		- 设置规则
		- 改过期时间
	- 3. 表结构问题
		- ~~status可以保留原有的，新增部分表key，然后试试跑两套是否ok？ 理论上是兼容的，关键是server的结构序列化查询问题， 发完后删除~~
		- ```
		  # tb_rule表可以加新的，无所谓。 老的还兼容旧的规则policy rule表不变； 
		  # 使用tb_audit_status_new  -----》 new来做  --- 发布一个集群移动一个   新的发布后如果云平调用老的接口会有问题吗？ 
		      
		  1. tb_audit_status 里的表结构和cynos一样， kafka 外键关联    es——host存在，但是es表和cynos一致
		  2. tb_es  tb_kafka均换   这俩oss无影响，不会用到直接去关联sql
		  
		  
		  
		  ```
	- TODO:
		- 1. agent要下发rule标记，否则都会到cos备份
		  2. publish_ audit cnf里的问题，会根据判定是否有规则回滚，start或关闭，这时候默认计入state都会有audit_all会有一定兼容问题 === done， 因为默认不在有规则触发审计开关的问题，开关必须是显示调用，迁移等值看status
		  3. 新的发了，删除policy，rule会导致默认成全审计，不会自动关闭 ---- 关闭必须显示调用
		  4. clear_inst_audit_data需要和云平确认 产品定以，现在默认是会关闭的，只要调用就shutdown  审计 了 ----- 
		  5. agent的cnf下发方式，必须在触发aggent下发时，先更新audit_status，比如consumer，必须更新 --- 必须先注册了
		  6[[$red]]==. 发布之前必须去掉用户的kaffka实例导入到cdb kafka，默认不支持了==